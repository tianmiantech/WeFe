<template>
    <el-card
        class="page"
        shadow="never"
    >
        <el-form inline>
            <el-form-item label="客户名称：">
                <el-input
                    v-model="search.clientName"
                    clearable
                />
            </el-form-item>

            <el-form-item label="服务名称：">
                <el-input
                    v-model="search.serviceName"
                    clearable
                />
            </el-form-item>

            <el-form-item label="是否启用：">
                <el-select
                    v-model="search.status"
                    placeholder="请选择"
                    clearable
                >
                    <el-option
                        v-for="item in options"
                        :key="item.value"
                        :label="item.label"
                        :value="item.value"
                    />
                </el-select>
            </el-form-item>

            <el-form-item>
                <el-button
                    type="primary"
                    @click="getList({ to: true })"
                >
                    查询
                </el-button>
                <router-link
                    class="ml10"
                    :to="{name: 'client-service-add'}"
                >
                    <el-button>
                        添加客户服务
                    </el-button>
                </router-link>
            </el-form-item>
        </el-form>

        <el-table
            v-loading="loading"
            :data="list"
            stripe
            border
        >
            <div slot="empty">
                <TableEmptyData/>
            </div>
            <el-table-column
                label="序号"
                width="50"
                type="index"
            />
            <el-table-column
                label="客户名称"
                width="230"
            >
                <template slot-scope="scope">
                    <p>{{ scope.row.client_name }}</p>
                    <p class="id">{{ scope.row.client_id }}</p>
                </template>
            </el-table-column>
            <el-table-column
                label="服务名称"
                width="230"
            >
                <template slot-scope="scope">
                    <p>{{ scope.row.service_name }}</p>
                    <p class="id">{{ scope.row.service_id }}</p>
                </template>
            </el-table-column>

            <el-table-column
                label="服务类型"
                width="100"
            >
                <template slot-scope="scope">
                    <p>{{ scope.row.service_type }}</p>
                </template>
            </el-table-column>

            <el-table-column
                label="IP 白名单"
                width="200"
            >
                <template slot-scope="scope">
                    {{ scope.row.ip_add }}
                </template>
            </el-table-column>

            <el-table-column
                label="请求地址"
                width="100"
            >
                <template slot-scope="scope">
                    <el-tooltip
                        class="item"
                        effect="dark"
                        :content="scope.row.url"
                        placement="left-start"
                    >
                        <p v-if="scope.row.url.length >= 20">{{ scope.row.url.substring(0, 20) }} ...</p>
                        <p v-if="scope.row.url.length < 20">{{ scope.row.url }} </p>
                    </el-tooltip>
                </template>
            </el-table-column>

            <el-table-column
                label="单价(￥)"
                width="65"
            >
                <template slot-scope="scope">
                    {{ scope.row.unit_price }}
                </template>
            </el-table-column>

            <el-table-column
                label="付费类型"
                width="70"
            >
                <template slot-scope="scope">
                    {{ scope.row.pay_type }}
                </template>
            </el-table-column>

            <el-table-column
                label="启用状态"
                width="70"
            >
                <template slot-scope="scope">
                    {{ scope.row.status }}
                </template>
            </el-table-column>

            <el-table-column
                label="创建时间"
                width="120"
            >
                <template slot-scope="scope">
                    {{ scope.row.created_time | dateFormat }}
                </template>
            </el-table-column>

            <el-table-column
                label="创建人"
                width="70"
            >
                <template slot-scope="scope">
                    {{ scope.row.created_by }}
                </template>
            </el-table-column>

            <el-table-column
                label="修改人"
                width="70"
            >
                <template slot-scope="scope">
                    {{ scope.row.updated_by }}
                </template>
            </el-table-column>

            <el-table-column
                label="操作"
                width="140"
                fixed="right"
            >
                <template slot-scope="scope">
                    <el-button
                        v-if="scope.row.status === '未启用'"
                        type="success"
                        @click="open(scope.row,1)"
                    >
                        启用
                    </el-button>
                    <el-button
                        v-if="scope.row.status === '已启用'"
                        type="danger"
                        @click="open(scope.row,0)"
                    >
                        禁用
                    </el-button>


                    <router-link
                        :to="{
                            name: 'client-service-edit',
                            query: {
                                serviceId: scope.row.service_id,
                                clientId: scope.row.client_id,
                                status: scope.row.status,
                            }
                        }"
                    >
                        <el-button>
                            修改
                        </el-button>
                    </router-link>
                </template>
            </el-table-column>
        </el-table>
        <div
            v-if="pagination.total"
            class="mt20 text-r"
        >
            <el-pagination
                :total="pagination.total"
                :page-sizes="[10, 20, 30, 40, 50]"
                :page-size="pagination.page_size"
                :current-page="pagination.page_index"
                layout="total, sizes, prev, pager, next, jumper"
                @current-change="currentPageChange"
                @size-change="pageSizeChange"
            />
        </div>
    </el-card>
</template>

<script>

import table from '@src/mixins/table.js';
import {mapGetters} from 'vuex';

export default {
    name: 'ClientServiceList',
    mixins: [table],
    inject: ['refresh'],
    data() {
        return {
            search: {
                clientName: '',
                status: '',
                serviceName: '',
            },
            options: [{
                value: '1',
                label: '已启用',
            }, {
                value: '0',
                label: '未启用',
            }],
            changeStatusType: '',
            getListApi: '/clientservice/query-list',
        };
    },

    computed: {
        ...
            mapGetters(['userInfo']),
    },
    methods: {
        open(row, status) {
            this.$alert(status === 1 ? '是否启用？' : '是否禁用？', '警告', {
                confirmButtonText: '确定',
                callback: action => {
                    if (action === 'confirm') {
                        this.changeStatus(row, status);
                        setTimeout(() => {
                            this.refresh();
                        }, 1000);
                    }


                },
            });
        },

        async changeStatus(row, status) {

            const {code} = await this.$http.post({
                url: '/clientservice/update',
                data: {
                    serviceId: row.service_id,
                    clientId: row.client_id,
                    status: status,
                    unitPrice: row.unit_price,
                    payType: row.pay_type === '后付费' ? 0 : 1,
                    updatedBy: this.userInfo.nickname,
                },
            });

            if (code === 0) {
                this.$message({
                    type: 'success',
                    message: status === 1 ? '启用成功' : '禁用成功',
                });
            }
        },
    },
};
</script>

<style scoped>

</style>
